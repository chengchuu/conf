upstream node-koa-rain-a {
    server webnode:3224;
}

upstream mazey-go-gin-gee {
    server 127.0.0.1:3000;
}

server {
    listen 80;
    server_name i.mazey.net;
    root /web/i.mazey.net;
    index index.html index.htm;
    client_max_body_size 200m;

    # /feperf/
    location ^~ /feperf/ {
        alias /web/x/feperf/;
    }

    # /bootstrap-blueprints/
    location ^~ /bootstrap-blueprints/ {
        alias /web/bootstrap-blueprints/;
    }

    # /mazey-style/ Archived
    location ^~ /mazey-style/ {
        alias /web/archives/mazey-style/;
    }

    # /asset/ Archived
    location ^~ /asset/ {
        alias /web/archives/asset/;
        access_log /var/log/web/nginx_asset_access.log;
    }
    location ^~ /assets/ {
        alias /web/archives/asset/;
        access_log /var/log/web/nginx_asset_access.log;
    }

    # /cdn/ Archived
    location ^~ /cdn/ {
        alias /web/archives/cdn/;
        error_page 404 = @lib_404_redirect;
    }

    # /polestar/
    location ^~ /polestar/ {
        alias /web/webpack-build-demo/;
    }

    # /style/
    location ^~ /style/ {
        alias /web/mazey.css/;
    }

    # /icon/
    location ^~ /icon/ {
        alias /web/icon/;
    }

    # /lib/
    location ^~ /lib/ {
        alias /web/lib/;
        error_page 404 = @lib_404_redirect;
        expires 24h;
    }
    location @lib_404_redirect {
        return 302 /lib/all.js;
    }

    # Redirect to http://i.mazey.net/mazey/docs/index.html when 404.
    # https://segmentfault.com/a/1190000022315733
    location ^~ /mazey/docs/ {
        alias /web/lib/mazey/docs/v3/;
        error_page 404 = @mazey_docs_404_redirect;
    }
    location @mazey_docs_404_redirect {
        return 302 /mazey/docs/index.html;
    }

    # /api/
    location ~ ^/(api|t)/ {
        proxy_set_header    X-Real-IP $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header    Host  $http_host;
        proxy_set_header    X-Nginx-Proxy true;
        proxy_set_header    Connection "";
        proxy_pass http://mazey-go-gin-gee;
    }
    # /log/
    location = /log/robot.html {
        root /web;
    }
    location /log/ {
        return 403;
    }

    # /server|t/
    # TODO: 404 with JSON Data
    location ^~ /server/ {
        proxy_set_header    X-Real-IP $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header    Host  $http_host;
        proxy_set_header    X-Nginx-Proxy true;
        proxy_set_header    Connection "";
        proxy_pass http://node-koa-rain-a;
    }

    # /x/
    # Redirect: https://i.mazey.net/x/p/shuxin/index.php -> https://i.mazey.net/x/p/shuxin/index.html
    location = /x/p/shuxin/index.php { return 301 /x/p/shuxin/index.html; }
    location = /x/p/shuxin/about.php { return 301 /x/p/shuxin/about.html; }
    # Main
    location ^~ /x/ {
        alias /web/x/;
        expires 24h;
    }
    # Redirect: /p/ 301 to /x/p/
    location ~ ^/p/(.*)$ {
        return 301 /x/p/$1;
    }
    # Redirect: https://i.mazey.net/tool/markdown/ -> https://i.mazey.net/x/markdown/
    location ~ ^/tool/(.*)$ {
        return 301 /x/$1;
    }

    # Blog Uploads
    # https://i.mazey.net/uploads /web/blog-mazey-net/wp-content/uploads
    location ~ ^/uploads/(.*)$ {
        root /web/blog-mazey-net/wp-content;
        try_files /uploads/$1 /uploads/$1/ /uploads/$1/index.html =404;
    }

    # Redirect https://i.mazey.net/polestar/lib/tiny.css -> https://i.mazey.net/style/lib/tiny.css
    location ~ ^/polestar/lib/(.*)\.css$ {
        return 301 https://i.mazey.net/style/lib/$1.css;
    }

    # Redirect: https://i.mazey.net/mazey/lib/mazey.min.js -> https://i.mazey.net/lib/mazey/latest/mazey.min.js
    location = /mazey/lib/mazey.min.js {
        return 301 https://i.mazey.net/lib/mazey/latest/mazey.min.js;
    }

    include /web/conf/includes/security.conf;
    include /web/conf/includes/static.conf;
    include /web/conf/includes/access-control-allow-origin-all.conf;
    include /web/conf/includes/gzip.conf;
}

# Examples
# http://i.mazey.net/
# http://i.mazey.net/lib/mazey/latest/mazey.min.js
# http://i.mazey.net/x/markdown-cheat-sheet/index.html
# http://i.mazey.net/x/base/service-suspend-notice.html
# Jan 19, 2026
# http://i.mazey.net/mazey/docs/index.html
# http://i.mazey.net/cdn/layer/mobile/layer.js
# http://i.mazey.net/cdn/jquery-2.1.1.min.js
# http://i.mazey.net/cdn/bootstrap-3.4.1/css/bootstrap.min.css
# Jan 23, 2026
# http://i.mazey.net/polestar/lib/confluence.js
# http://i.mazey.net/polestar/lib/wordpress.js
# http://i.mazey.net/style/lib/confluence.css
# http://i.mazey.net/icon/fav/logo-dark-circle-transparent-32x32.png
# Jan 26, 2026
# http://i.mazey.net/asset/default/suzumiya-haruhi1.jpg
# http://i.mazey.net/assets/image/jpeg/2023-03-12-971617618-FmIGJtyaMAAqxZo.jpg
# Jan 28, 2026
# http://i.mazey.net/mazey-style/lib/tiny.css
# http://i.mazey.net/bootstrap-blueprints/index.html
# http://i.mazey.net/feperf/sdk/prd/report.js
